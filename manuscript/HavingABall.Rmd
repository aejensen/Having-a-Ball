---
title: "Having a Ball: evaluating scoring streaks and game excitement using in-match trend estimation"
author: | 
  | `r x <- sample(1:2) ; paste0((c("Andreas Kryger Jensen", "Claus Thorn Ekstrøm")[x]), collapse=" and ")`
  | `r paste0(c("(0000-0002-8233-9176)", "(0000-0003-1191-373X)")[x], collapse=", ")`
  | Biostatistics, Department of Public Health, University of Copenhagen
  | `r paste0(c("aeje@sund.ku.dk", "ekstrom@sund.ku.dk")[x], collapse=", ")`
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontsize: 11pt  
header-includes:
  - \usepackage{bm}
  - \usepackage{amssymb}
  - \usepackage[labelfont=bf]{caption}
  - \DeclareMathOperator*{\argsup}{arg\,sup}  
  - \DeclareMathOperator*{\argmin}{arg\,min}  
  - \DeclareMathOperator*{\E}{E}
  - \DeclareMathOperator*{\Cov}{Cov}
  - \DeclareMathOperator*{\Cor}{Cor}
  - \DeclareMathOperator*{\Var}{Var}
  - \DeclareMathOperator*{\Erf}{Erf}
  - \DeclareMathOperator*{\Erfc}{Erfc}
  - \usepackage{multirow}
  - \usepackage{float}
  - \floatstyle{plaintop}
  - \restylefloat{table}
  - \usepackage[thmmarks]{ntheorem}
  - \theoremstyle{nonumberplain}
  - \usepackage{xcolor}
  - \newcommand{\revision}[1]{\textcolor{red}{#1}}
  - \usepackage{fontawesome5}
  - \usepackage{todonotes}
  - \newcommand{\BTheta}{\ifthenelse{\value{bbsym4theta}=1}{\text{\faBasketballBall}}{\mathbf{\Theta}}}
  - \authorrunning{`r paste0((c("AK Jensen", "CT Ekstrøm")[x]), collapse=" and ")`}
  - \titlerunning{Having a Ball}
  - \institute{Biostatistics, Department of Public Health\\University of Copenhagen\\ Øster Farimagsgade 5\\ 1014 København K\\ DENMARK}
output:
  pdf_document: 
    keep_tex: no
    number_sections: yes
documentclass: svjour3
bibliography: bibliography.bib    
editor_options: 
  chunk_output_type: console
---

\newpage

\newcounter{bbsym4theta}
\setcounter{bbsym4theta}{1}

\begin{abstract}

Many popular sports involve matches between two teams or players where
each team have the possibility of scoring throughout the match. While
the overall winner and result is interesting it conveys little
information about the underlying scoring trends throughout the
match. Modeling approaches that accommodate a finer granularity of the
score difference throughout the match is needed in order to evaluate
game strategies, discuss scoring streaks, teams strengths, and other
aspects of the game.

We propose a latent Gaussian process to model the score difference
between two teams and introduce the Trend Direction Index as an easily
interpretable probabilistic measure of the current trend in the match
as well as a measure of post-game trend evaluation. In addition we
propose the Excitement Trend Index --- the expected number of
monotonicity changes in the trend of the running score difference ---
as a measure of overall game excitement.

We apply the our proposed methodology to analyze all 1143 matches from
the 2019--2020 National Basketball Association (NBA) season, and show
how the trends can be interpreted in individual games and how the
excitement score can be used to cluster teams according to how
exciting they are to watch.
\end{abstract}

\begin{center}
\textbf{Keywords:} Bayesian Statistics, Gaussian Processes, Sports Statistics, Trends, APBRmetrics
\end{center}


# Declarations {-}

**Funding**: The research was funded by the University of Copenhagen.

**Conflicts of interest/Competing interests**: None

**Availability of data and material**: All data are available at \url{https://github.com/aejensen/Having-a-Ball}

**Code availability**: All code are available at \url{https://github.com/aejensen/Having-a-Ball} and \url{https://github.com/aejensen/TrendinessOfTrends}.


\newpage

# Introduction

Sports analytics receive increasing attention within statistics and not just for match prediction or betting but also for game evaluation, in-game and post-game coaching purposes, and for setting strategies and tactics in future matches. 

Many popular sports such as football (soccer), basketball, boxing, table tennis, volleyball, American football, and handball involve matches between two teams or players where each team have the possibility of scoring throughout the match. Several research papers seek to predict match results (e.g., @skellam2; @groll2019; @Gu2019) or match winners for single matches (@cattelan2013bradley) in order to infer the match winner and potentially the winner of a tournament (@ekstrom2020trps; @baboota).  While the overall result is highly interesting it conveys very little information about the individual development and trends throughout the match and modeling approaches that allow a finer granularity of the score difference throughout the match are needed.

The trend in score difference between the two teams is a proxy for their underlying strengths. In particular, sustained periods of time where the score difference increases suggests that one team outperforms the other whereas periods where the teams are constantly catching up to each other suggest that the team's strengths in those periods are similar. Modeling the local trend of the score difference will therefore reflect several aspects of the game in particular the team strengths and game dynamics and momentum as they develop through the match.

Figure \ref{fig1} shows the development of the score difference for the final match of the playoffs in the 2020 National Basketball Association (NBA) series between Los Angeles Lakers and Miami Heat. Positive numbers indicate that LA Lakers are leading and the running score difference shows that the Lakers pulled ahead until the third quarter where Miami Heat started to keep up the scoring pace before overtaking the Lakers and reducing the lead.

\begin{figure}[htb]
\center
\includegraphics{../figures/fig1-raw.pdf}
\caption{Game development in the final match of the NBA 2019--2020 season between Los Angeles Lakers and Miami Heat. October 11, 2020. Positive values indicate that LA Lakers are leading.}
\label{fig1}
\end{figure}

In this paper we will consider the score difference between two teams as a latent Gaussian process and use the Trend Direction Index (TDI) from @ToT as an accommodating measure to evaluate the local probability of the *monotonicity* of the latent process at a given time point during a match. The Trend Direction Index uses a Bayesian framework to provide a direct answer to questions such as "What is the probability that the latent process (i.e., that one team is doing better than another) is increasing at a given time-point?". This will allow real-time evaluation of the score difference trend at the current time-point in the game and will provide post-game inference about the "hot" periods of a match where one team out-performed the other. Furthermore we will present the Excitement Trend Index (ETI) as an objective measure of spectator excitement in a given match. The ETI is defined as the expected number of times that the score difference changes monotonicity during a match. If the score difference changes monotonicity often then that echos a game where both teams frequently score whereas a game with a low ETI will represent a one-sided match where one team is doing consistently better than the other over sustained periods of time.


Other authors have considered using continuous processes to model the score difference of matches. @gabel2012random shows that NBA basketball score difference is well described by a continuous-time anti-persistent random walk which suggests that a latent Gaussian process might be viable.

* @chen2020rank
* @chen2018functional

The paper is structured as follows. In the next section we introduce trend modeling of score differences through a latent Gaussian process and define the Trend Direction Index and Excitement Trend Index that captures the local trends in monotonicity and game excitement, respectively. In Section \ref{sec:application} we apply the our proposed methodology to analyze both the final match of the playoff as well as evaluating the game excitement distribution of the season by considering the ETI from all 1143 matches from the 2019--2020 National Basketball Association (NBA) season. We show how this distribution can be used to assess relative match excitement and how the ETI can be used to classify teams according to their average level of match excitement. We conclude with a discussion in Section \ref{sec:discussion}. Materials to reproduce this manuscript and its analyses can be found at @HavingABall.

Unused stuff for now: 

* Philosophical question: What exactly is the sampling model for a single match?


# Methods {#sec:method}

Our model is based on the observed score differences $D_m$ in a given match indexed by $m$. For each match we observe the random variables $\mathcal{D}_m = \left(t_{mi}, D_{mi}\right)_{0 < i \leq J_m}$ where $t_{m1} < t_{m2} < t_{mi} < \ldots < t_{m J_m}$ are the ordered time points at which any teams scores, $D_{mi} = D_m(t_{mi})$ is the associated difference in scores at time $t_{mi}$, and $J_m$ is the total number of scorings during the match. We use the convention that $D_m$ is the difference in scores of the away team with respect to the home team, so that $D_m(t) > 0$ means that the away team is leading at time $t$.

We assume that the observed match data from a given match are noisy realizations of a latent smooth, random function defined in continuous time evaluated at the random time points where goals occur. Let $d_m$ be the latent functions from which the realizations $\mathcal{D}_m$ are generated. Our objective is to infer $d_m$ and its time dynamics from $\mathcal{D}_m$. In pursuance of this ambition we propose the following model where $d_m$ is a Gaussian process defined on a compact subset of the real line $\mathcal{I}_m$ corresponding to the duration of the $m$'th game, and the observed data conditional on the scoring times and the values of the latent process at these times are independently normally distributed random variables with a match specific variance. This model for a given match can be stated hierarchically as
\begin{align}
\begin{split}
  \BTheta_m \mid \bm{\Psi_m}, \mathbf{t}_m &\sim H(\BTheta_m \mid \bm{\Psi}_m)\\
  d_m(t) \mid \BTheta_m &\sim \mathcal{GP}(\mu_{\bm{\beta}_m}(t), C_{\bm{\theta}_m}(s, t))\\
  D_m(t_{mi}) \mid d_m(t_{mi}), t_{mi}, \BTheta_m &\overset{iid}{\sim} N\left(d_m(t_{mi}), \sigma_{m}^2\right)
\end{split}
\label{eq:hierarchicalmodel}
\end{align}
where $\BTheta_m = (\bm{\beta}_m, \bm{\theta}_m, \sigma_{m}^2)$ is a vector of hyper-parameters governing the dynamics of the latent Gaussian process with a prior distribution $H$ indexed by parameters $\bm{\Psi}_m$, and $\mathbf{t}_m = (t_{m1}, \ldots, t_{m J_m})$ is the vector of time points where goals occurs in the match. The functions $\mu_{\bm{\beta}_m}$ on $\mathcal{I}_m$ and $C_{\bm{\theta}_m}$ on $\mathcal{I}_m \times \mathcal{I}_m$ are the prior mean and covariance functions of the latent Gaussian process, and $\sigma_m^2$ is the variance characterizing the magnitudes deviations between for the observed score differences and the values of the latent process.

A Gaussian process is characterized by the multivariate joint normality of all of the joint distributions resulting from evaluating the process at any finite set of time points (@rasmussen2003gaussian). Specifically, for any finite set $\mathbf{t}^\ast \subset \mathcal{I}_m$ it follows that that the vector $d(\mathbf{t}^\ast) \mid \BTheta_m$ is distributed as $N(\mu_{\bm{\beta}_m}(\mathbf{t}^\ast), C_{\bm{\theta}_m}(\mathbf{t}^\ast, \mathbf{t}^\ast))$ where $\mu_{\bm{\beta}_m}(\mathbf{t}^\ast)$ is the vector generated by evaluating the prior mean function $\mu_{\bm{\beta}_m}(t)$ at $\mathbf{t}^\ast$ and $C_{\bm{\theta}_m}(\mathbf{t}^\ast, \mathbf{t}^\ast))$ is the covariance matrix generated by evaluating the prior covariance function $C_{\bm{\theta}_m}(s,t)$ at $\mathbf{t}^\ast \times \mathbf{t}^\ast$. Using the properties of multivariate normal distributions the posterior distribution of $d_m(\mathbf{t}^\ast) \mid \mathcal{D}_m, \BTheta_m$ is also a multivariate normal distribution. This facilitates Bayesian estimation of the distribution of the latent process governing the score difference given the observed data from each match. 

In addition to obtaining inference for the latent process we may also estimate its time dynamics. This follows since a Gaussian process along with its time derivatives (provided they exist) are distributed as a multivariate Gaussian process (@cramer1967stationary). We can therefore augment the model in Equation (\ref{eq:hierarchicalmodel}) with an additional latent structure of the first and second derivatives of $d_m$ with respect to time as
\begin{align}
  \begin{bmatrix}d_m(s)\\ d^{\prime}_m(t)\\ d^{\prime\prime}_m(u)\end{bmatrix} \mid \BTheta_m &\sim \mathcal{GP}\left(\begin{bmatrix}\mu_{\bm{\beta}_m}(s)\\ \mu^{\prime}_{\bm{\beta}_m}(t)\\ \mu^{\prime\prime}_{\bm{\beta}_m}(u)\end{bmatrix}, \begin{bmatrix}C_{\bm{\theta}_m}(s, s^\prime) & \partial_2 C_{\bm{\theta}_m}(s, t) & \partial_2^2 C_{\bm{\theta}_m}(s, u)\\ \partial_1 C_{\bm{\theta}_m}(t, s) & \partial_1 \partial_2 C_{\bm{\theta}_m}(t, t^\prime) & \partial_1 \partial_2^2 C_{\bm{\theta}_m}(t, u)\\ \partial_1^2 C_{\bm{\theta}_m}(u, s) & \partial_1^2\partial_2 C_{\bm{\theta}_m}(u, t) & \partial_1^2 \partial_2^2 C_{\bm{\theta}_m}(u, u^\prime)\end{bmatrix}\right)
\label{eq:dynamics}
\end{align}
where $^\prime$ and $^{\prime\prime}$ denote the first and second time derivatives, $\partial_j^k$ is the $k$'th order partial derivative with respect to the $j$'th variable. Combining the models in Equations (\ref{eq:hierarchicalmodel}) and (\ref{eq:dynamics}) we obtain explicit expressions for the posterior distributions $d^\prime_m \mid \mathcal{D}_m, \BTheta_m$ and $d^{\prime \prime}_m \mid \mathcal{D}_m, \BTheta_m$. The posterior joint distributions of the latent processes can be expressed as the multivariate Gaussian process
\begin{align}
\begin{bmatrix}d_m(s)\\ d_m^\prime(t)\\ d_m^{\prime\prime}(u)\end{bmatrix} \mid \mathcal{D}_m, \BTheta_m \sim \mathcal{GP}\left(\begin{bmatrix}\mu_{d_m}(s)\\ \mu_{d_m^\prime}(t)\\ \mu_{d_m^{\prime\prime}}(u)\end{bmatrix}, \begin{bmatrix} \Sigma_{d_m}(s, s^\prime) & \Sigma_{d_m d_m^\prime}(s,t) & \Sigma_{d_m d_m^{\prime\prime}}(s,u)\\ \Sigma_{d_m^\prime d_m}(t,s) & \Sigma_{d_m^\prime}(t,t^\prime) & \Sigma_{d_m^\prime d_m^{\prime\prime}}(t,u)\\ \Sigma_{d_m^{\prime\prime} d_m}(u,s) & \Sigma_{d_m^{\prime\prime} d_m^\prime}(u,t) & \Sigma_{d_m^{\prime\prime}}(u,u^\prime)\end{bmatrix}\right)
\label{eq:posterior}
\end{align}
where explicit expressions for the posterior mean and covariance functions are given in the supplementary material. In practice this means that we can sample from the posterior joint distribution at any finite number of time points as this will be equal to sampling from a high-dimensional normal distribution. We use the posteriors of the first and second time derivatives of the latent process to characterize the dynamical properties of each match through the Trend Direction Index (TDI) and the Excitement Trend Index (ETI).


We define the Trend Direction Index (TDI) of a particular match $m$ as the local posterior probability that $d_m$ is an increasing function for all time points $t \in \mathcal{I}_m$. Under our model this is equal to
\begin{align}
\begin{split}
  \textrm{TDI}_m(t \mid \BTheta_m) &= P\left(d_m^\prime(t) > 0 \mid \mathcal{D}_m, \BTheta_m\right)\\
     &= \frac{1}{2} + \frac{1}{2}\Erf\left(\frac{\mu_{d_m^\prime}(t)}{2^{1/2}\Sigma_{d_m^\prime}(t, t)^{1/2}}\right)
\end{split}
\label{eq:TDIdef}
\end{align}
where $\Erf\colon\, x \mapsto 2\pi^{-1/2}\int_0^x \exp(-u^2)\mathrm{d}u$ is the error function and $\mu_{d_m^\prime}$ and $\Sigma_{d_m^\prime}$ are the posterior mean and covariance functions of the time derivative defined in Equation (\ref{eq:posterior}). The interpretation of the TDI is that it quantifies the probability that one team is currently increasing the differences in scores or equivalently that they are changing the trend in their favor. A TDI equal to $50\%$ means that the game is in a stagnant state. We note that the TDI is symmetric with respect to the reference team in the definition of the score difference. Is the reference team is changed, then $\textrm{TDI}$ changes to $1 - \textrm{TDI}$.

To each match we assign its Excitement Trend Index, denoted by $\text{ETI}_m$, as a global index of excitement. The index is defined as the expected number of changes in monotonicity of the posterior distribution of $d_m$ which is equivalent to the expected number of zero-crossings of the posterior distribution of $d^\prime_m$. We hence define
\begin{align}
\begin{split}
  \text{ETI}_m \mid \BTheta_m &= \E\left[\#\left\{t \in \mathcal{I}_m : d^\prime_m(t) = 0\right\} \mid \mathcal{D}_m, \BTheta_m\right]\\
  &= \int_{\mathcal{I}_m} d\mathrm{ETI}_m(t \mid \BTheta_m)\mathrm{d}t
\end{split}
\label{eq:ETIdef}
\end{align}
where $d\mathrm{ETI}_m$ is the instantaneous posterior probability of a zero-crossing of $d^\prime$ at any time point $t \in \mathcal{I}_m$. Under the model described in Equations (\ref{eq:hierarchicalmodel}) and (\ref{eq:dynamics}) it can be shown that $d\mathrm{ETI}$ is equal to
\begin{align*}
d\mathrm{ETI}_m(t \mid \BTheta_m) = \lambda_m(t)\phi\left(\frac{\mu_{d_m^\prime}(t)}{\Sigma_{d_m^\prime}(t,t)^{1/2}}\right)\left(2\phi\left(\zeta_m(t)\right) + \zeta_m(t)\Erf\left(\frac{\zeta_m(t)}{2^{1/2}}\right)\right)
\end{align*}
where $\phi\colon\, x \mapsto 2^{-1/2}\pi^{-1/2}\exp(-\frac{1}{2}x^2)$ is the standard normal density function, and $\lambda_m$, $\omega_m$ and $\zeta_m$ are functions defined by		
\begin{gather*}
  \lambda_m(t) = \frac{\Sigma_{d_m^{\prime\prime}}(t,t)^{1/2}}{\Sigma_{d_m^\prime}(t,t)^{1/2}}\left(1-\omega_m(t)^2\right)^{1/2}, \quad \omega_m(t) = \frac{\Sigma_{d_m^\prime d_m^{\prime\prime}}(t,t)}{\Sigma_{d_m^\prime}(t,t)^{1/2}\Sigma_{d_m^{\prime\prime}}(t,t)^{1/2}}\\
  \zeta_m(t) = \frac{\mu_{d_m^\prime}(t)\Sigma_{d_m^{\prime^\prime}}(t,t)^{1/2}\omega_m(t)\Sigma_{d_m^\prime}(t,t)^{-1/2} - \mu_{d_m^{\prime\prime}}(t)}{\Sigma_{d_m^{\prime\prime}}(t,t)^{1/2}\left(1 - \omega_m(t)^2\right)^{1/2}}
\end{gather*}
A derivation of these expressions can be found in the supplementary material to @ToT. \textbf{[??? give some explanation/intuition about the value ???]}. We note that ETI is invariant with respect to the reference team in the definition of the score differences as it is defined as the expected number of both up- and down-crossings at zero of the posterior trend.

Both the Trend Direction Index and the Excitement Trend Index in Equations (\ref{eq:TDIdef}) and (\ref{eq:ETIdef}) are random variables due to their dependence on the hyper-parameters $\BTheta_m$. In our Bayesian framework these are specified under an additional layer of prior distributions according to $H(\BTheta_m \mid \bm{\Psi}_m)$. By fitting the model using Markov-Chain Monte Carlo methods (MCMC) we obtain the posterior distribution $\widetilde{\BTheta}_m \sim P(\BTheta_m \mid \mathcal{D}_m, \bm{\Psi}_m, \mathbf{t}_m)$ given by
\begin{align*}
  \widetilde{\BTheta}_m &\sim \frac{H(\BTheta_m \mid \bm{\Psi}_m) \int P(\mathbf{D}_m \mid d_m(\mathbf{t}_m), \BTheta_m, \bm{\Psi}_m, \mathbf{t}_m)dP(d_m(\mathbf{t}_m) \mid \BTheta_m, \bm{\Psi}_m, \mathbf{t}_m)}{\iint P(\mathbf{D}_m \mid d_m(\mathbf{t}_m), \BTheta_m, \bm{\Psi}_m, \mathbf{t}_m)dP(d_m(\mathbf{t}_m) \mid \BTheta_m, \bm{\Psi}_m, \mathbf{t}_m)dH(\BTheta_m \mid \bm{\Psi}_m)}
\end{align*}
and the posterior estimates of TDI and ETI are therefore the random variables $\textrm{TDI}_m(t) \mid \widetilde{\BTheta}_m$ and $\textrm{ETI}_m \mid \widetilde{\BTheta}_m$. \textbf{[??? check notation ???]}

To summarize the posterior distributions of TDI and ETI we one can either use the average value calculated by integrating over the distribution of $\widetilde{\BTheta}_m$ or
\begin{align*}
\overline{\mathrm{TDI}}_m(t) &= \int \widetilde{\BTheta}_m \mathrm{TDI}_m(t \mid \widetilde{\BTheta}_m)dP(\widetilde{\BTheta}_m)\\
\overline{\mathrm{TDI}^p}_m(t) &= \sup\left\{\mathrm{TDI}_m(t \mid \widetilde{\BTheta}_m) : \mathrm{TDI}_m(t \mid \widetilde{\BTheta}_m) < p\right\}
\end{align*}

\textbf{[??? look this through ???]}


## Estimation {-}

To complete the specification of the model in Equation (\ref{eq:hierarchicalmodel}) we need to specify prior mean and covariance functions for the latent process. The choice of these are application specific and can be based on prior knowledge of the game dynamics. We refer to the discussion in @ToT for more information on such choices.

In our application we used a constant prior mean and the squared exponential covariance function given by
\begin{align*}
  \mu_{\bm{\beta}_m}(t) = \beta_m, \quad C_{\bm{\theta}_m}(s, t) = \alpha^2_m\exp\left(-\frac{(s-t)^2}{2\rho^2_m}\right)
\end{align*}
with $\bm{\theta}_m = (\alpha_m, \rho_m) > 0$ and hence $\BTheta_m = (\beta_m,\alpha_m, \rho_m,\sigma^2)$. \textbf{[??? Note: Infinitely differetiable sample paths. Sample path derivatives are well-defined]} For the hyper-parameters of $\BTheta_m$ we used independent, heavy-tailed distribution with a moderate variance centered at the marginal maximum likelihood estimates of the form
\begin{align*}
H(\BTheta_m \mid \bm{\Psi}_m) = H(\beta_m \mid \Psi_{\beta_m})H(\alpha_m \mid \Psi_{\alpha_m})H(\rho_m \mid \Psi_{\rho_m})H(\sigma_m \mid \Psi_{\sigma_m})
\end{align*}
with
\begin{align*}
\beta_{m} \sim T_4\left(\widehat{\beta_m^\text{ML}}, 5\right), \quad \alpha_m \sim T^+_4\left(\widehat{\alpha_m^\text{ML}}, 5\right), \quad \rho_m \sim T_4^+\left(\widehat{\rho_m^\text{ML}}, 5\right), \quad \sigma_m \sim T^+_4\left(\widehat{\sigma_m^\text{ML}}, 5\right)
\end{align*}
where $T_{\text{df}}$ denotes a location-scale T distribution with $\mathrm{df}$ degrees of freedom, and $T_{\text{df}}^+$ is the distribution truncated to the positive real line.

We have implemented the estimation procedure in the probabilistic programming language Stan [@carpenter2017stan] using the Hamiltonian MCMC (Markov Chain Monte Carlo) algorithm to sample from the posterior distributions $\textrm{TDI}_m(t \mid \widetilde{\BTheta}_m)$ and $d\mathrm{ETI}_m(t \mid \widetilde{\BTheta}_m)$ on a equidistant grid of $200$ time points in $\mathcal{I}_m$. For each match we ran four independent chains for 25,000 iterations each with half of the iterations used for warm-up. The posterior distribution of $\text{ETI}_m \mid \widetilde{\BTheta}_m$ was calculated by numerical integration of $d\mathrm{ETI}_m(t \mid \widetilde{\BTheta}_m)$ using the trapezoidal rule on the grid of time points.


# Application: The 2019--2020 NBA basketball season {#sec:application}

To show the applicability of our proposed model we will apply it to data from all regular games from the 2019--2020 NBA basketball season (obtained from @BBreference and provided in @HavingABall). A lot of points are scored during a basketball match so it is easy to see the development of the score difference in a single match. 

The 2019--2020 NBA season was suspended mid-March because of Covid-19 but it was resumed again in July 2020. There were a total of 1059 regular season matches. The subsequent playoffs comprised 84 matches including the final for a grand total of 1143 matches. For ease of comparison we are only considering the first 48 regular minutes of each match --- any part of a match that goes into overtime will be disregarded, and we hence let $\mathcal{I}_m = [0; 48]$ minutes.

We wish to use the trend analysis proposed for three purposes: 1) to show how the Trend Direction Index can be used to infer real-time and post-game evaluation of the trends in a match. 2) To evaluate the Excitement Trend Index for all 1143 matches in the 2019--2020 season to provide background and reference information about the matches, and 3) to summarize ETI at the team level in order to identify group of teams more/less likely to give an exciting game. 

For our first purpose of analyzing trends in individuals matches we consider the final match of the 2019-2020 season. The raw data for the running score difference between LA Lakers and Miami Heat was shown in Figure \ref{fig1}. Figure \ref{fig1b} shows the results from the post-game analysis. 

\begin{figure}[htbp]
\includegraphics{../figures/fig1.pdf}
\caption{Results from fitting the latent Gaussian Process to the final match between LA Lakers and Miami Heat in the 2019--2020 NBA season. Larger values in first and last panels reflect the situation where LA Lakers are doing better. The first panel shows the posterior distribution of the the latent process with the posterior means in bold. The gray areas show point-wise credibility intervals for the posterior distribution. The middle panel provides similar information for the derivative of the latent process, i.e., the posterior trend. The final panel shows the Trend Direction Index and can be used to read off probability statements about the trends in the running score difference.}
\label{fig1b}
\end{figure}

Evaluating the game trends from the TDI in Figure \ref{fig1b} shows that LA Lakers had control of most of the match since the posterior probability of a positive trend was high throughout most of the match. Only towards the end of the third quarter did Miami Heat gain the upper hand and had a period where they fought back. In the 4th quarter from around 38 minutes to 43 minutes we can see that mean TDI increases to over 80% but the probability interval is very wide reflecting that it is difficult to say whether the trend is increasing or if it might as well just be random fluctuations in scores. Similarly for the first half of the 3rd quarter. Teams wishing to evaluate the match should primarily concentrate on periods where the latent trend and its probability interval is either close to 50% or when the trend is disadvantageous for the team. 


To evaluate the overall distribution of ETIs we fitted our model to each of the 1143 matches during the season and estimated the ETI for each. The results are summarized in the left panel of Figure \ref{fig2} which shows the marginal distribution of the median posterior Excitement Trend Indices. The solid line shows the fit of a Gaussian mixture model with four components, where the number of components were determined by sequential bootstrapped likelihood ratio testing (@mclust). The marginal distribution of ETIs is right skewed (skewness = 0.53) with a range of $[0.23; 26.28]$, and an median of 10.09 (mean = 10.62, SD = 4.52). This implies that the time-varying score differences of the games in the season changes monotonicity approximately 10 times during a game on average but with a large variation between matches. For comparison, the final match between LA Lakers and Miami Heat shown in Figure \ref{fig1b} has an ETI of \textbf{XXX}.


\begin{figure}[htbp]
\includegraphics{../figures/fig2.pdf}
\caption{Histogram and Gaussian mixture distribution estimate of the distribution of 1143 median posterior ETIs from the NBA 2019--2020 season (left panel) and the median posterior ETIs as a function of calendar time from October 22, 2019 to October 11, 2020 (right panel).}
\label{fig2}
\end{figure}

We wished to examine if there was a calendar time effect on game excitement as the season progressed in order to investigate if we could find that games became more close as the teams fought to stay in the competition to enter the final playoffs or if we could detect a fatigue over the season. The right panel of Figure \ref{fig2} shows the median posterior ETIs as a function of calendar time at which the matches were played. Besides illustrating the gap from the Covid-19 hiatus, the figure shows that the excitement indices are relatively evenly distributed throughout the season.

If we rank the matches from lowest to highest ETI we can extract the analyses for representative matches spanning the ETI range. Figure \ref{fig3} shows the analyses of our proposed method for the minimum, 1st, 2nd, 3rd quantile, and maximum ETI matches. It is quite clear from the observed running score differences, posterior trends and the TDI that these five matches represent substantially different game experiences. The second row of Figure  \ref{fig3} for the Charlotte Hornets vs Chicago Bulls match indicates that while the Hornets were leading for almost the first three quarters then the game trend was rather flat since the two teams kept the pace with each other for most of the game.  In contrast, the match between New Orleans Pelicans vs Utah Jazz (5th row in Figure \ref{fig3}) showed trends that varied direction frequently and where the TDI showed alternating periods of scoring bursts making it a very exciting and unpredictable game. \textbf{Okay ... lidt tykt smurt på her.}

Summarizing the posterior median ETIs at the team level across all matches during the season lead to comparable values for all 30 teams. Table \ref{tab:teamsummary} shows the summary statistics for all 30 teams ordered by their season average excitement. The New Orleans Pelicans had the highest median posterior ETI averaged over the season with an average median posterior ETI of 11.67 (SD = 4.91, IQR = $[3.09; 23.57]$), while the Charlotte Hornets had the lowest average median posterior ETI with a value of 9.29 (SD = 3.74, IQR = $[1.96; 15.98]$). This small fluctuation of averages suggests that the teams are comparable in terms of excitement when averaging across the season, and that the major source of variation in excitement during the season (as seen in Figure \ref{fig2}) is governed by the specific matches. 

Although the team averages in Table \ref{tab:teamsummary} show limited variability it is of interest to estimate a number of subgroups among the teams that exhibited similar degree of excitement on average during the season -- effectively clustering the teams. This would enable fans, promoters, and sponsors to infer which teams were more likely to partake in an exciting game.
The problem is mathematically equivalent to looking at the relationship between the median ETIs as the outcome in a linear regression model where the explanatory categorical variable ranges over the set of all partitions of 30 elements, and as the objective we seek the smallest number of partitions that best explains the observed ETIs by comparing all possible splits of the ranked teams for a given number of partitions. This will then define subgroups of teams.

As a optimization criterion we used root mean squared error of predicting based on leave-one-out cross-validation, denoted $\textrm{RMSEP}_\text{LOO-CV}$. [\textbf{??? finish this ???}].

Our sequential optimization procedure showed that the leave-one-out cross-validated root mean squared error of prediction stabilized at four subgroups ($\textrm{RMSEP}_\text{LOO-CV}^{C=2} = 4.500$, $\textrm{RMSEP}_\text{LOO-CV}^{C=3} = 4.497$, $\textrm{RMSEP}_\text{LOO-CV}^{C=4} = 4.496$, and subsequently for $C = 5,\ldots,8$ it remained at the same value). The labels of these groups are shown in the rightmost column in Table  \ref{tab:teamsummary}. The result is thus an identification of three estimated change-points in the ranking of the teams according to the average median posterior ETI. The most noticeable result is that Charlotte Hornets constitute a singleton since that team has substantial lower ETI than the team with the second lowest ETI. To have a higher probability of seeing an exciting game it would be wise to avoid the Hornets.


# Discussion {#sec:discussion}

Some summarization goes on here. We have introduced etc...

We could define a weighted Excitement Trend Index, $\mathrm{WETI}_m$, so that changes in monotonicity of the score differences are i) weighted higher towards the end of the game and ii) weighted lower if one team is already far away of the other team as measured by the absolute value of the posterior mean $\mu_{d_m}$. This motivates a modification of the definition of the ETI in Equation (\ref{eq:ETIdef}) to the following weighted form
\begin{align*}
  \mathrm{WETI}_m\mid \BTheta_m = \int_{\mathcal{I}_m} d\mathrm{ETI}_m(t \mid \BTheta_m)w(t, |\mu_{d_m}(t)|)\mathrm{d}t
\end{align*}
where $w\colon\, \mathcal{I}_m \times \mathbb{R}_{\geq 0} \mapsto \mathbb{R}_{\geq 0}$ is a weight function being increasing in its first variable and decreasing in its second variable. Such weight functions could be constructed as a product of two kernel functions defined on their individual domains and with bandwidths based on studies of psychological perception.

A different approach would be to define team-specific excitement index nested with a match. Here we would only look at the **up**-crossings at zero of $df_m$ and we would get two excitement indices for each match $(\mathrm{ETI}_{am}, \mathrm{ETI}_{bm})$. for teams $a$ and $b$. This would somehow reflect how exciting each team were in match $m$ with respect to chancing the sign of the score differences in their favor.

# Bibliography {-}

<div id="refs"></div>

\newpage

\begin{figure}[htbp]
\includegraphics{../figures/fig3.pdf}
\caption{Observed score differences with posteriors of the latent processes (left panels), posterior trends (middle panels) and posterior Trend Direction Indices (right panels) for five games from the NBA season 2019--2020 with median posterior Excitement Trend Indices corresponding to the 0\%, 25\%, 50\%, 75\%, and 100\% percentiles of the distribution of all games in the season. Gray regions depict 50\% and 95\% point-wise credible intervals.}
\label{fig3}
\end{figure}

\newpage 

```{r, echo=FALSE}
library(kableExtra)
load("../results/ETI_team_analysis.RData")

teamData$groups <- teamData$team
levels(teamData$groups) <- as.vector(floor(part_4$optim$bestmem))

teams_tab <- as.matrix(table(teamData$team, teamData$groups))
teamAverages <- sapply(rownames(teams_tab), function(name) {
	mean(teamData[teamData$team == name, "ETI"])
})
teamSD <- sapply(rownames(teams_tab), function(name) {
	sd(teamData[teamData$team == name, "ETI"])
})
teamLower <- sapply(rownames(teams_tab), function(name) {
	quantile(teamData[teamData$team == name, "ETI"], 0.025)
})
teamMedian <- sapply(rownames(teams_tab), function(name) {
	quantile(teamData[teamData$team == name, "ETI"], 0.5)
})
teamUpper <- sapply(rownames(teams_tab), function(name) {
	quantile(teamData[teamData$team == name, "ETI"], 0.975)
})
class = apply(teams_tab, 1, function(q) as.numeric(colnames(teams_tab))[which.max(q)])

tab <- data.frame(Average = teamAverages, 
                  SD = teamSD, 
                  "lower" = teamLower, 
                  "median" = teamMedian,
                  "upper" = teamUpper,
                  class = class)
colnames(tab) <- c("Average", "SD", "2.5%", "50%", "97.5%", "class_num")
tab <- tab[order(tab$Average, decreasing=TRUE), ]
tab$Group <- tab$class_num
tab$Group[tab$class_num == "2"] <- "A"
tab$Group[tab$class_num == "0"] <- "B"
tab$Group[tab$class_num == "3"] <- "C"
tab$Group[tab$class_num == "1"] <- "D"
tab$class_num <- NULL

kable(tab, 
      format = "latex", digits = 2, booktabs = TRUE,
      linesep = c("", "", "", ""), 
      align = c("r", "r|", "r", "r", "r|", "r"),
			caption = "Team specific median posterior Excitement Trend Indices summarized across all their matches in the 2019--2020 NBA season ordered by the season average. Additionally, standard deviations and 2.5\\%, 50\\%, and 97.5\\% percentiles are shown. The group column shows the clustering induced by the sequential optimization procedure.\\label{tab:teamsummary}") %>% row_spec(8, hline_after = TRUE) %>% row_spec(18, hline_after = TRUE) %>% row_spec(29, hline_after = TRUE)
```
